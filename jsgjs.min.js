!function(){function a(a){return this.data=a,this.where=this.filter,this.having=this.filter,this.orderBy=this.sort,this}function b(b,c){b instanceof a&&(this.parent=b,b=this.parent.data);var d=[];return b.forEach(function(a){c(a)&&d.push(a)}),this.parent?this.parent.setData(d):new a(d)}function c(b,c){if(b instanceof a&&(this.parent=b,b=this.parent.data),c instanceof a&&(this.parent=c,c=this.parent.data),j(b)&&j(c)){this.headers={};for(var d in b[0])this.headers[d]="left";for(var e in c[0])void 0==this.headers[e]?this.headers[e]="right":this.headers[e]="both";this.joinableHeaders=[];for(var f in this.headers)"both"==this.headers[f]&&this.joinableHeaders.push(f);return this.left=b,this.right=c,this}}function d(a){this.JoinObject=a;var b=a.headers,c=a.on,d=a.joinableHeaders;if(this.joined=!1,this.row={},this.row[c]=null,d.length>1){for(var e in b)if(e!=c)if("both"==b[e]){var f=e+"-left",g=e+"-right";this.row[f]=null,this.row[g]=null}else this.row[e]=null}else for(var e in b)e!=c&&(this.row[e]=null);return this}function e(b,c,d){if(b instanceof a&&(this.parent=b,b=this.parent.data),j(b)){d=f(d),this.data=b,this.headers=[];for(var e in b[0])this.headers[e]=typeof b[0][e];if(c="string"==typeof c?[c]:c,!this.checkHeaderArray(c)&&"All"!=c[0])throw JSON.stringify(c)+" is not a valid header";if(!this.checkHeaderArray(d))throw JSON.stringify(d)+" is not a valid header";return this.groupBy=c,this.fields=d,this.operate()}}function f(a){a instanceof Array||(a=[a]);for(var b={},c=0;c<a.length;c++){var d;if("string"==typeof a[c]){var e=a[c].split("::");d={header:e[0],operations:[e[1]||"sum"]}}else{if(!a[c].header||!a[c].operations)throw"Fields must be given as an array eg. [{header:x, operations:['sum','avg']} or ['x::sum','x::avg']";d=a[c]}void 0==b[d.header]&&(b[d.header]={header:d.header,operations:[]}),d.operations.forEach(function(a){b[d.header].operations.push(a)})}var f=[];for(var g in b)f.push(b[g]);return f}function g(a,b){this.row={},this.tempRow={},this.fields=a.fields,this.groupBy=a.groupBy;for(var c=0;c<this.groupBy.length;c++)this.row[this.groupBy[c]]=b[this.groupBy[c]],this.tempRow[this.groupBy[c]]=b[this.groupBy[c]];for(var d=0;d<this.fields.length;d++){var e=this.fields[d].header;this.tempRow[e]={},this.fields[d].operations instanceof Array||(this.fields[d].operations=[this.fields[d].operations]);for(var f=0;f<this.fields[d].operations.length;f++){var g=this.fields[d].operations[f];"unique"!=g&&"median"!=g&&"avg"!=g&&"mode"!=g&&"parse"!=g?this.tempRow[e][g]=0:"avg"==g?(this.tempRow[e].count=0,this.tempRow[e].sum=0):"unique"==g||"mode"==g?this.tempRow[e][g]={}:"median"==g&&(this.tempRow[e][g]=[]),"max"!=g&&"min"!=g||(this.tempRow[e][g]="number"==typeof b[e]?b[e]:null)}}return this}function h(b,c){b instanceof a&&(this.parent=b,b=this.parent.data),this.data=b,this.selectionArray=c,this.fields=[],c.forEach(function(a,b){this.fields[b]={title:null,val:null},"string"==typeof a?(this.fields[b].val=a,this.fields[b].title=a):a.val?(this.fields[b].val=a.val,this.fields[b].title=a.title):(this.fields[b].val=a.title,this.fields[b].title=a.title)}.bind(this)),this.rows=[];for(var d=0;d<this.data.length;d++)this.rows.push(new i(this.fields,this.data[d]).row);return this.finish()}function i(a,b){this.row={},a=a;for(var c in a)this.row[a[c].title]=null;for(var d=0;d<a.length;d++){var e=a[d];"function"==typeof e.val?this.addValue(e.title,e.val(b)):this.addValue(e.title,b[e.val])}return this}function j(a){if(!(a instanceof Array))throw"data given was not an array "+JSON.stringify(a);if(!(a[0]instanceof Object))throw"data[0] was not an object "+JSON.stringify(a[0]);return!0}a.prototype={constructor:a,setData:function(a){return this.data=a,this},join:function(a){return new c(this,a)},leftJoin:function(a,b){return new c(this,a).allJoins(b,!0,!1,!1)},rightJoin:function(a,b){return new c(a,this).allJoins(b,!0,!1,!1)},innerJoin:function(a,b){return new c(this,a).allJoins(b,!1,!0,!1)},outterJoin:function(a,b){return new c(this,a).allJoins(b,!1,!1,!0)},select:function(a){return new h(this,a)},group:function(a,b){return new e(this,a,b)},sort:function(a,b){function c(a,b){return function(c,d){var e=c[a]<d[a]?-1:c[a]>d[a]?1:0;return e*b}}return void 0===b&&a.includes("::")&&(b=a.split("::")[1],a=a.split("::")[0]),"string"==typeof b&&(b="desc"==b.toLowerCase()?-1:1),this.data=this.data.sort(c(a,b)),this},filter:function(a){return new b(this,a)},result:function(){return this.data}},"undefined"==typeof module&&(a.prototype.export=function(a,b){if(!k[a])throw"cant Export "+a;b=b||a,window[b]=k[a]}),c.prototype={constructor:c,getDefaultRow:function(){return new d(this)},results:function(){return this.rows},leftJoin:function(a){return this.allJoins(a,!0,!1,!1)},innerJoin:function(a){return this.allJoins(a,!1,!0,!1)},outterJoin:function(a){return this.allJoins(a,!1,!1,!0)},allJoins:function(a,b,c,d){if(this.on=a,void 0==this.headers[a])throw a+" is not a valid header (as per row[0]";if("both"!=this.headers[a])throw a+" is only found in the "+this.headers[a]+" table";return this.joiningObject={},this.fillLeft().fillRight(d).flattenJoin(c).finish()},fillLeft:function(){for(var a=this.left.length,b=0;b<a;b++){if(this.left[b][this.on]instanceof Object||this.left[b][this.on]instanceof Array)throw"Row"+b+" :objects are not premitted in the joining field "+this.left[b][this.on];if(null!==this.left[b][this.on]&&void 0!==this.left[b][this.on]){void 0==this.joiningObject[this.left[b][this.on]]&&(this.joiningObject[this.left[b][this.on]]=[]);var c=this.getDefaultRow().fillRowLeft(this.left[b]);this.joiningObject[this.left[b][this.on]].push(c)}else console.log("row "+[b]+" tried to join on a null value! this behaviour is not permitted, the row has been removed :"+this.left[b])}return this},fillRight:function(a){for(var b=this.on,c=this.right.length,d=0;d<c;d++){if(this.right[d][this.on]instanceof Object||this.right[d][this.on]instanceof Array)throw"Row"+d+" :objects are not premitted in the joining field: "+JSON.stringify(this.right[d][this.on]);if(a){void 0==this.joiningObject[this.right[d][b]]&&(this.joiningObject[this.right[d][b]]=[]);var e=this.getDefaultRow().fillRowRight(this.right[d]);this.joiningObject[this.right[d][b]].push(e)}else if(void 0!=this.joiningObject[this.right[d][b]]){for(var f=this.joiningObject[this.right[d][b]].length,g=[],h=0;h<f;h++)if("both"==this.joiningObject[this.right[d][b]][h].isJoined()){var e=this.joiningObject[this.right[d][b]][h].duplicateRow().fillRowRight(this.right[d]);g.push(e)}else this.joiningObject[this.right[d][b]][h].fillRowRight(this.right[d]);for(var i=0;i<g.length;i++)this.joiningObject[this.right[d][b]].push(g[i])}}return this},flattenJoin:function(a){this.rows=[];for(var b in this.joiningObject)for(var c=0;c<this.joiningObject[b].length;c++)a&&"both"!=this.joiningObject[b][c].isJoined()||this.rows.push(this.joiningObject[b][c].getRow());return this.joiningObject=void 0,this},finish:function(){return this.parent?this.parent.setData(this.rows):new a(this.row)}},d.prototype={constructor:d,isJoined:function(){return this.joined},getRow:function(){return this.row},duplicateRow:function(){return new d(this.JoinObject).fillRowLeft(this.row)},fillRowLeft:function(a){return this.fillRow(a,"left")},fillRowRight:function(a){return this.fillRow(a,"right")},fillRow:function(a,b){var c=0;for(var d in a)if(void 0===this.row[d]){var e=d+"-"+b;if(void 0===this.row[e])throw"rows not standard "+JSON.stringify(a)+" element "+d+" was unexpected: ensure that row[0] is a descriptive row matching the standard dataset";this.row[e]=a[d],c++}else this.row[d]=a[d],c++;return c>0&&(this.joined?this.joined="both":this.joined=b),this}},e.prototype={constructor:e,operate:function(){this.temp={};for(var a=this.data.length,b=0;b<a;b++){var c="All"==this.groupBy[0]?"All":this.makeGroupEl(b);void 0==this.temp[c]&&(this.temp[c]=new g(this,this.data[b])),this.temp[c].operate(this.data[b])}this.rows=[];for(var d in this.temp){var e=this.temp[d].flatten().row;this.rows.push(e)}return this.data=void 0,this.temp=void 0,this.finish()},finish:function(){return this.parent?this.parent.setData(this.rows):new a(this.row)},makeGroupEl:function(a){for(var b=this.data[a],c="",a=0;a<this.groupBy.length;a++)c+=b[this.groupBy[a]];return c},headerType:function(a){return this.headers[a]},checkHeaderArray:function(a){for(var b=0;b<a.length;b++){var c=a[b].header||a[b];if(!this.headerType(c))return!1}return!0}},g.prototype={constructor:g,operate:function(a){for(var b=0;b<this.fields.length;b++){var c=this.fields[b].header,d=a[c];if(this.fields[b].operations.join().includes("parse")&&(d=parseFloat(d)),void 0!=d){var e=this.tempRow[c];if(void 0!==e.count&&this.tempRow[c].count++,void 0===e.unique||e.unique[d]||(this.tempRow[c].unique[d]=!0),void 0!==e.mode&&(e.mode[d]?this.tempRow[c].mode[d]++:this.tempRow[c].mode[d]=1),"number"!=typeof d)return console.log(d+" value of this row was not a number"),console.log(a),this;void 0!==e.sum&&(this.tempRow[c].sum+=d),void 0!==e.max&&e.max<d&&(this.tempRow[c].max=d),void 0!==e.min&&e.min>d&&(this.tempRow[c].min=d),void 0!==e.median&&this.tempRow[c].median.push(d)}}return this},flatten:function(){for(var a=0;a<this.fields.length;a++)for(var b=this.fields[a].header,c=0;c<this.fields[a].operations.length;c++){var d=this.fields[a].operations[c];this.simpleCombine(d,b)}return this},simpleCombine:function(a,b){return"unique"==a||"median"==a||"avg"==a||"mode"==a?this[a](b):(this.row[b+"_"+a]=this.tempRow[b][a],this)},avg:function(a){return this.row[a+"_avg"]=this.tempRow[a].sum/this.tempRow[a].count,this},unique:function(a){var b=0;for(var c in this.tempRow[a].unique)b++;return this.row[a+"_unique"]=b,this},median:function(a){var b=this.tempRow[a].median.sort(function(a,b){return a-b}),c=Math.floor(b.length/2);return this.row[a+"_median"]=b[c],this},mode:function(a){var c,b=void 0;for(var d in this.tempRow[a].mode)void 0===b&&(b=this.tempRow[a].mode[d],c=d),b<this.tempRow[a].mode[d]&&(b=this.tempRow[a].mode[d],c=d);return this.row[a+"_mode"]=c,this}},h.prototype={constructor:"Select",finish:function(){return this.parent?this.parent.setData(this.rows):new a(this.row)}},i.prototype.addValue=function(a,b){if(void 0===this.row[a])throw a+" is not a valid header";return this.row[a]=b,this},"undefined"!=typeof module?module.exports=a:window.JSG=a;var k={Group:e,Select:h,Join:c}}();